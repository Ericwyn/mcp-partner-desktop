name: CI

on:
  # 保留官方触发条件：指定分支的push、PR、手动触发
  push:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  pull_request:
    branches: [ "main", "v2", "v3", "dev", "*-*" ]
  workflow_dispatch:
  # 新增：Release正式发布时触发（用于编译+上传产物）
  release:
    types: [published]

# 全局环境变量（解决OOM、统一Wails版本）
env:
  NODE_OPTIONS: "--max-old-space-size=4096"
  WAILS_VERSION: "v2.11.0"  # 统一官方指定的Wails版本

jobs:
  # ===================== Linux 系列 =====================
  ubuntu2404:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner到项目根目录（官方步骤后、构建前）
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
          ls -la ./mcp-partner  # 验证克隆（可选，调试用）
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2404  # 新增ID，用于后续定位产物
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false # 保持官方配置：不自动上传
      # 新增：Release发布时，上传该产物到GitHub Release
      - name: Upload to Release (ubuntu2404)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu2404.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true

  ubuntu2204:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2204
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false
      # 新增：Release上传
      - name: Upload to Release (ubuntu2204)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu2204.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true

  ubuntu2004:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu2004
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          package: false
      # 新增：Release上传
      - name: Upload to Release (ubuntu2004)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu2004.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true

  ubuntu-obfuscate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-ubuntu-obfuscate
        with:
          build-name: wails
          build-platform: linux/amd64
          wails-build-webview2: "embed"
          build-obfuscate: true
          package: false
      # 新增：Release上传（混淆版）
      - name: Upload to Release (ubuntu-obfuscate)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-ubuntu-obfuscate.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          # 重命名产物，区分混淆版
          file_name: wails-linux-obfuscate

  # ===================== macOS 系列 =====================
  macos15arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos15arm64
        with:
          build-name: wails
          build-platform: darwin/universal
          sign: "false"
          wails-version: ${{ env.WAILS_VERSION }}  # 复用全局变量
          sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
          sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
          sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
          sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
          sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
          sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
          sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
          package: false
      # 新增：Release上传
      - name: Upload to Release (macos15arm64)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-macos15arm64.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos15-universal

  macos14arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos14arm64
        with:
          build-name: wails
          build-platform: darwin/universal
          sign: "false"
          wails-version: ${{ env.WAILS_VERSION }}
          sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
          sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
          sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
          sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
          sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
          sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
          sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
          package: false
      # 新增：Release上传
      - name: Upload to Release (macos14arm64)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-macos14arm64.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos14-universal

  macos13amd64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos13amd64
        with:
          build-name: wails
          build-platform: darwin/universal
          sign: "false"
          wails-version: ${{ env.WAILS_VERSION }}
          sign-macos-apple-password: ${{ secrets.APPLE_PASSWORD }}
          sign-macos-app-id: "Developer ID Application: Lethean LTD (W2DNA5L5DY)"
          sign-macos-app-cert: ${{ secrets.MAC_DEVELOPER_CERT }}
          sign-macos-app-cert-password: ${{ secrets.MAC_DEVELOPER_PASS }}
          sign-macos-installer-id: "Developer ID Installer: Lethean LTD (W2DNA5L5DY)"
          sign-macos-installer-cert: ${{ secrets.MAC_DEVELOPER_INSTALL_CERT }}
          sign-macos-installer-cert-password: ${{ secrets.MAC_DEVELOPER_INSTALL_PASS }}
          package: false
      # 新增：Release上传
      - name: Upload to Release (macos13amd64)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-macos13amd64.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos13-universal

  macos-obfuscate:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
        shell: bash
      - uses: dAppServer/wails-build-action@main
        id: build-macos-obfuscate
        with:
          build-name: wails
          build-platform: darwin/universal
          build-obfuscate: true
          wails-version: ${{ env.WAILS_VERSION }}
          package: false
      # 新增：Release上传（混淆版）
      - name: Upload to Release (macos-obfuscate)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-macos-obfuscate.outputs.build-output-dir }}/wails
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-macos-obfuscate

  # ===================== Windows 系列 =====================
  windows2025:
    runs-on: windows-2025
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner（Windows兼容bash）
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2025
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2025)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2025.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2025.exe

  windows2022:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2022
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2022)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2022.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2022.exe

  windows2019:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows2019
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: 'false'
          package: false
      # 新增：Release上传
      - name: Upload to Release (windows2019)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows2019.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows2019.exe

  windows-nsis:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows-nsis
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          nsis: "true"
          package: false
      # 新增：Release上传（NSIS安装包）
      - name: Upload to Release (windows-nsis)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          # NSIS产物默认在build目录下，后缀为.exe安装包
          files: ${{ steps.build-windows-nsis.outputs.build-output-dir }}/*.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows-installer.exe

  windows-obfuscate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      # 新增：克隆mcp-partner
      - name: Clone mcp-partner repository
        shell: bash
        run: |
          git clone https://github.com/Ericwyn/mcp-partner.git ./mcp-partner
          rm -rf ./mcp-partner/node_modules ./mcp-partner/package-lock.json
      - uses: dAppServer/wails-build-action@main
        id: build-windows-obfuscate
        with:
          build-name: wails.exe
          build-platform: windows/amd64
          wails-build-webview2: "embed"
          build-obfuscate: true
          package: false
      # 新增：Release上传（混淆版）
      - name: Upload to Release (windows-obfuscate)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build-windows-obfuscate.outputs.build-output-dir }}/wails.exe
          tag_name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite: true
          file_name: wails-windows-obfuscate.exe
